<!doctype html>
<html lang="es">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
	<title>Cambios</title>
	<link rel="stylesheet" href="css/bootstrap.css" />
	<link rel="stylesheet" href="css/estilos.css" />
</head>
<body>
	<!-- Button trigger modal 1 -->
	<button id="modalbox" class="btn btn-primary btn-lg hidden" data-toggle="modal" data-target="#myModal">
	  	Modal
	</button>
	<!-- Modal 1 -->
	<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" data-backdrop="static" data-keyboard="false" >
	  	<div class="modal-dialog">
	    	<div class="modal-content">
		      <div class="modal-header">
			        <h4 class="modal-title alert alert-warning" id="myModalLabel">Mensaje</h4>
		      </div>
		      <div class="modal-body">
		      		<div class="alert alert-info" id="mensajes" role="alert"></div>
		      </div>
		      <div class="modal-footer text-left">
			        <button type="button" data-dismiss="modal" id="conservar" class="btn-lg btn-primary" >Agregar</button>
			        <button type="button" data-dismiss="modal" id="cancelar" class="btn-lg btn-danger" >Cancelar</button>
		      </div>
	    	</div>
	  	</div>
	</div>
	<!-- Modal 1 -->
	<div class="text-right">
		<a href="index.html" class="icono-menu" >
			MENU <span class="glyphicon glyphicon-align-justify" ></span>
		</a>
	</div>
	<form class="form-horizontal my_form" role="form" name="form_cambios" action="" method="POST" >
		<div class="form-group">
			<div class="text-center">
		   		<label for="dia" class="control-label label_grande">FECHA</label>
		   	</div>
		    <div class="col-sm-4 col-xs-4">
		      <input type="number" class="form-control input_grande" id="dia" name="dia" autocomplete="off" placeholder="Día" >
		    </div>
		    <div class="col-sm-4 col-xs-4">
		      <input type="number" class="form-control input_grande" id="mes" name="mes" autocomplete="off" placeholder="Mes" >
		    </div>
		    <div class="col-sm-4 col-xs-4">
		      <input type="number" class="form-control input_grande" id="annio" name="annio" autocomplete="off" placeholder="Año" >
		    </div>
		     <div class="row">
		    	<div class="alert alert-danger text-center col-sm-10 col-md-6" id="error-fecha" role="alert">
		      		<h2>ERROR!</h2>
		      	</div>
		    </div
		</div>
		<div class="form-group">
			<div class="text-center">
		   		<label for="maquina" class="control-label label_grande">MAQUINA</label>
		   	</div>
		   	<div class="col-md-3"></div>
		    <div class="col-sm-10 col-md-6">
		    	<select name="maquina" id="maquina" class="form-control input_grande" >
				</select>		      
		    </div>
		    <div class="row">
		    	<div class="alert alert-danger text-center col-sm-10 col-md-6" id="error-maquina" role="alert">
		      		<h2>SELECCIONAR!</h2>
		      	</div>
		    </div>
		</div>
		<div class="form-group">
			<div class="text-center">
		   		<label for="nombre" class="control-label label_grande">NOMBRE</label>
		   	</div>
			<div class="col-sm-1 col-xs-1"></div>
		   	<div class="col-sm-4 col-xs-4">
		   		<select id="ini_nombre" class="form-control input_grande" ></select>
		    </div>
		   	<div class="col-sm-5 col-xs-5">
		      	<input type="number" class="form-control input_grande" id="nombre" name="nombre" >
		    </div>
		</div>
		<div class="row">
			<div class="col-md-4"></div>
	    	<div class="alert alert-danger text-center col-sm-1 col-md-4" id="error-nombre" role="alert">
	      		<h2>ERROR!</h2>
	      	</div>
	    </div>
		<div class="form-group">
			<div class="text-center">
		    	<label for="linea" class="control-label label_grande">LINEA</label>
		    </div>
		    <div class="col-md-3"></div>
		    <div class="col-sm-10 col-md-6">
		      	<select name="linea" id="linea" class="form-control input_grande" >
				</select>
		    </div>
		</div>
		<div id='kilos_hora' class="form-group">
			<div class="text-center">
		   		<label for="kgs_hora" class="control-label label_grande">KILOS/HORA</label>
		   	</div>
		   	<div class="col-sm-6 col-xs-6">
		      	<input type="number" class="form-control input_grande" id="kgs_hora" name="kgs_hora" >
		    </div>
		   	<div class="col-sm-1 col-xs-1">
		    	<label class="control-label label_grande">.</label>
		    </div>
		    <div class="col-sm-5 col-xs-5">
		      	<input type="number" class="form-control input_grande" id="kgs_hora2" name="kgs_hora2" >
		    </div>
		    <div class="row">
		    	<div class="alert alert-danger text-center col-sm-10 col-md-6" id="error-kgs_hora" role="alert">
		      		<h2>COMPLETAR!</h2>
		      	</div>
		    </div>
		</div>
		<div id="ne" class="form-group">
			<div class="text-center">
		   		<label for="titulo" class="control-label label_grande">TITULO</label>
		   	</div>
		   	<div class="col-sm-6 col-xs-6">
		      	<input type="number" class="form-control input_grande" id="titulo" name="titulo" >
		    </div>
		   	<div class="col-sm-1 col-xs-1">
		    	<label class="control-label label_grande">.</label>
		    </div>
		    <div class="col-sm-5 col-xs-5">
		      	<input type="number" class="form-control input_grande" id="titulo2" name="titulo2" >
		    </div>
		    <div class="row">
		    	<div class="alert alert-danger text-center col-sm-10 col-md-6" id="error-titulo" role="alert">
		      		<h2>COMPLETAR!</h2>
		      	</div>
		    </div>
		</div>
		<div id="napa" class="form-group">
			<div class="text-center">
		   		<label for="peso_napa" class="control-label label_grande">PESO NAPA</label>
		   	</div>
		   	<div class="col-sm-6 col-xs-6">
		      	<input type="number" class="form-control input_grande" id="peso_napa" name="peso_napa" >
		    </div>
		   	<div class="col-sm-1 col-xs-1">
		    	<label class="control-label label_grande">.</label>
		    </div>
		    <div class="col-sm-5 col-xs-5">
		      	<input type="number" class="form-control input_grande" id="peso_napa2" name="peso_napa2" >
		    </div>
		    <div class="row">
		    	<div class="alert alert-danger text-center col-sm-10 col-md-6" id="error-peso_napa" role="alert">
		      		<h2>COMPLETAR!</h2>
		      	</div>
		    </div>
		</div>
		<div id="tor" class="form-group">
			<div class="text-center">
		   		<label for="torsion" class="control-label label_grande">TORSION</label>
		   	</div>
		   	<div class="col-sm-6 col-xs-6">
		      	<input type="number" class="form-control input_grande" id="torsion" name="torsion" >
		    </div>
		   	<div class="col-sm-1 col-xs-1">
		    	<label class="control-label label_grande">.</label>
		    </div>
		    <div class="col-sm-5 col-xs-5">
		      	<input type="number" class="form-control input_grande" id="torsion2" name="torsion2" >
		    </div>
		    <div class="row">
		    	<div class="alert alert-danger text-center col-sm-10 col-md-6" id="error-torsion" role="alert">
		      		<h2>COMPLETAR!</h2>
		      	</div>
		    </div>
		</div>
		<div id="vel_pro" class="form-group">
			<div class="text-center">
		   		<label for="vp" class="control-label label_grande">VEL. PROD.</label>
		   	</div>
		   	<div class="col-sm-6 col-xs-6">
		      	<input type="number" class="form-control input_grande" id="vp" name="vp" >
		    </div>
		   	<div class="col-sm-1 col-xs-1">
		    	<label class="control-label label_grande">.</label>
		    </div>
		    <div class="col-sm-5 col-xs-5">
		      	<input type="number" class="form-control input_grande" id="vp2" name="vp2" >
		    </div>
		    <div class="row">
		    	<div class="alert alert-danger text-center col-sm-10 col-md-6" id="error-vp" role="alert">
		      		<h2>COMPLETAR!</h2>
		      	</div>
		    </div>
		</div>
		<div id="rpm_huso" class="form-group">
			<div class="text-center">
		   		<label for="rpm" class="control-label label_grande">RPM/HUSO</label>
		   	</div>
		   	<div class="col-sm-6 col-xs-6">
		      	<input type="number" class="form-control input_grande" id="rpm" name="rpm" >
		    </div>
		   	<div class="col-sm-1 col-xs-1">
		    	<label class="control-label label_grande">.</label>
		    </div>
		    <div class="col-sm-5 col-xs-5">
		      	<input type="number" class="form-control input_grande" id="rpm2" name="rpm2" >
		    </div>
		    <div class="row">
		    	<div class="alert alert-danger text-center col-sm-10 col-md-6" id="error-rpm" role="alert">
		      		<h2>COMPLETAR!</h2>
		      	</div>
		    </div>
		</div>
		<div class="form-group">
			<div class="text-center">
		   		<label for="contador" class="control-label label_grande">CONTADOR</label>
		   	</div>
		   	<div class="col-md-3"></div>
		    <div class="col-sm-10 col-md-6">
		      <input type="number" class="form-control input_grande numero" id="contador" name="contador" autocomplete="off" >
		    </div>
		    <div class="row">
		    	<div class="alert alert-danger text-center col-sm-10 col-md-6" id="error-contador" role="alert">
		      		<h2>COMPLETAR!</h2>
		      	</div>
		    </div>
		</div>
		<div class="form-group">
			<div class="text-center">
		   		<label for="hora" class="control-label label_grande">HORA</label>
		   	</div>
		   	<div class="col-sm-1 col-xs-1"></div>
		    <div class="col-sm-4 col-xs-4">
		      <input type="number" class="form-control input_grande numero" maxlength="5" id="hora" name="hora" autocomplete="off" placeholder="HH" >		      
		    </div>
		    <div class="col-sm-1 col-xs-1">
		    	<label class="control-label label_grande">:</label>
		    </div>
		    <div class="col-sm-4 col-xs-4">
		    	<input type="number" class="form-control input_grande numero" maxlength="5" id="minutos" name="minutos" autocomplete="off" placeholder="MM" >
		    </div>
		    <div class="col-sm-2 col-xs-2"></div>
		    <div class="row">
		    	<div class="col-sm-2 col-xs-2"></div>
			    <div class="col-sm-4 col-xs-4">
			    	<div class="alert alert-danger text-center" id="error-hora" role="alert">
			      		<h2>ERROR!</h2>
			      	</div>
			    </div>
			    <div class="col-sm-2 col-xs-2"></div>
			    <div class="col-sm-4 col-xs-4">
			    	<div class="alert alert-danger text-center" id="error-minutos" role="alert">
			      		<h2>ERROR!</h2>
			      	</div>
			    </div>
		    </div>
		</div>
		<div class="form-group">
		    <div class="col-sm-offset-3">
		      <a href="cambiomenu.html" class="btn btn-danger boton" >ATRAS</a>
		      <button type="submit" class="btn btn-primary boton">GUARDAR</button>		      
		    </div>
		</div>
	</form>
<script type="text/javascript" src="js/jquery.min.js" ></script>
<script type="text/javascript" src="js/bootstrap.js" ></script>
<script>	
	var Json_cambios_pre;
	var array = [];
	if (localStorage.getItem("lis_cambios_pre")!=null){
		my_array = JSON.parse(localStorage.getItem("lis_cambios_pre"));
		array = JSON.parse(localStorage.getItem("lis_cambios_pre"));
	}
	if(localStorage.getItem('id_cam_pre')==null){
		localStorage.setItem('id_cam_pre',1);
	}
	// FECHA Y HORA
		var fecha = new Date();
		hora = fecha.getHours();
		dia = fecha.getDate();
		mes = fecha.getMonth()+1;
		annio = fecha.getFullYear();
		if(dia<10) dia = String("0"+dia);
		if(mes<10) mes = String("0"+mes);		
		fecha_string = String(annio+"-"+mes+"-"+dia);		
		minutos = fecha.getMinutes();
		if(hora<10)	hora = String("0"+hora);
		if(minutos<10) minutos = String("0"+minutos);
		hora_string = String(hora+":"+minutos+":"+"00");
	// FECHA Y HORA

	$(function(){
		// Tipo de preparacion
		array_tp = JSON.parse(localStorage.getItem("tipo_preparacion"));
		for(var i=0;i<array_tp.length;i++){
			$('#maquina').append('<option value='+array_tp[i].id+' >'+array_tp[i].descripcion+'</option>');
		}
		annio_2 = String(annio).substring(2,4);
		$('#dia').val(dia);
		$('#mes').val(mes);
		$('#annio').val(annio_2);
		$('.alert-danger').css('display','none');

	    $("#hora").keyup(function(event){
		    if($(this).val().length==2){
		        $('#minutos').focus();
		    }
		});

		// Lineas
		array_lineas = JSON.parse(localStorage.getItem("lineas"));
		for(var i=0;i<array_lineas.length;i++){
			$('#linea').append('<option value='+array_lineas[i].id+' >'+array_lineas[i].descripcion+'</option>');
		}

		$('#cancelar').on('click',function(){
			$('#mensajitos').remove();
		});

		$('#conservar').on('click',function(){
			array.push(Json_cambios_pre);
			var jsontostring = JSON.stringify(array);
			localStorage.setItem("lis_cambios_pre", jsontostring);
			$('.alert-success').show().delay(5000).fadeOut();
			$('#mensajitos').remove();
			window.location = 'cambiomenu.html';
		});	

		/* COMBOS LETRA INICIAL MAQUINA */
		ini_m = JSON.parse(localStorage.getItem('maquinas_pre_inicial'));
		for(var i=0;i<ini_m.length;i++){
			id_maq = $('#maquina').val();
			if(ini_m[i].tipo == id_maq){
				$('#ini_nombre').append('<option value='+ini_m[i].nombre+' >'+ini_m[i].nombre+'</option>');
			}
		}		
		$("#maquina").change(function() {
			id_maq = $('#maquina').val();
			codigo = "";
			for(var i=0;i<array_tp.length;i++){
				if(id_maq==array_tp[i].id){
					codigo = array_tp[i].codigo;
				}
			}
			switch(codigo){
			    case "02":
			    	$('#kilos_hora').css('display','block');
			    	$('#ne').css('display','block');
			    	$('#napa').css('display','none');
			    	$('#tor').css('display','none');
			    	$('#vel_pro').css('display','none');
			    	$('#rpm_huso').css('display','none');
			        break;
			    case "03":			        
			        $('#kilos_hora').css('display','none');
			    	$('#ne').css('display','block');
			    	$('#napa').css('display','block');
			    	$('#tor').css('display','none');
			    	$('#vel_pro').css('display','block');
			    	$('#rpm_huso').css('display','none');
			        break;
			    case "04":			        
			    	$('#kilos_hora').css('display','block');
			    	$('#ne').css('display','block');
			    	$('#napa').css('display','none');
			    	$('#tor').css('display','none');
			    	$('#vel_pro').css('display','block');
			    	$('#rpm_huso').css('display','none');
			        break;
			    case "05":			        
			    	$('#kilos_hora').css('display','none');
			    	$('#ne').css('display','block');
			    	$('#napa').css('display','none');
			    	$('#tor').css('display','none');
			    	$('#vel_pro').css('display','block');
			    	$('#rpm_huso').css('display','none');
			        break;
			    case "06":			        
			    	$('#kilos_hora').css('display','none');
			    	$('#ne').css('display','block');
			    	$('#napa').css('display','none');
			    	$('#tor').css('display','block');
			    	$('#vel_pro').css('display','none');
			    	$('#rpm_huso').css('display','block');
			        break;
			}
			$('#ini_nombre option').remove();
		 	for(var i=0;i<ini_m.length;i++){
				if(ini_m[i].tipo == id_maq){
					$('#ini_nombre').append('<option value='+ini_m[i].nombre+' >'+ini_m[i].nombre+'</option>');
				}
			}
		});
		$("#maquina").change();
		/* COMBOS LETRA INICIAL MAQUINA */

		$('form[name=form_cambios]').on('submit',function(evt){
			evt.preventDefault();	
			fec = "20"+$('#annio').val()+"-"+$('#mes').val()+"-"+$('#dia').val();
			nombre = $('#ini_nombre').val()+$('#nombre').val();		
			if(valida(nombre,fec)==1){
				HoraTwoPto = $('#hora').val()+":"+$('#minutos').val();
				Json_cambios_pre = {
					"id" : localStorage.getItem("id_cam_pre"),
					"maquina" : $('#maquina').val(),
					"nombre" : nombre,					
					"linea" : $("#linea").val(),
					"kgs_hora" : VerVacio("kgs_hora")+"."+VerVacio("kgs_hora2"),
					"titulo" : VerVacio("titulo")+"."+VerVacio("titulo2"),
					"peso_napa" : VerVacio("peso_napa")+"."+VerVacio("peso_napa2"),
					"torsion" : VerVacio("torsion")+"."+VerVacio("torsion2"),
					"vp" : VerVacio("vp")+"."+VerVacio("vp2"),
					"rpm" : VerVacio("rpm")+"."+VerVacio("rpm2"),
					"contador" : $('#contador').val(),
					"hora_cambio" : HoraTwoPto+":00",
					"fecha" : fec,
					"fecha_ingreso":fecha_string,
					"hora" : hora_string,
					"estado" :1,
				}
				var indicator = 0;
				var entrada = 0;
				ac = JSON.parse(localStorage.getItem('lis_cambios_pre'));
				if (ac!=null) {
					for (i=0;i<ac.length;i++){
						if(fec == ac[i]['fecha']){
							if($('#maquina').val() == ac[i]['maquina'] && nombre == ac[i]['nombre']){
								entrada = 1;
								if(indicator==0){
									$('#modalbox').click();
									indicator = 1;
									$('#mensajes').append("<div id='mensajitos' ></div>");
								}						
								$('#mensajitos').append("<h5 >Esta maquina ya tiene cambio en este día, su hora es: "+ac[i]['hora_cambio']+".</h5>");
							}
						}
					}
				}
				if (entrada==0){
					array.push(Json_cambios_pre);
					var jsontostring = JSON.stringify(array);
					localStorage.setItem("lis_cambios_pre", jsontostring);
					id_cam_pre = parseInt(localStorage.getItem("id_cam_pre"));
					localStorage.setItem('id_cam_pre',id_cam_pre+1);
					window.location = "cambiomenu.html";
				}
			}

			function valida(nombre,fec){
				var rpta = 1;				
				if($('#nombre').val()==""){
					rpta = 0;
					$('#error-nombre').show().delay(5000).fadeOut();
				}else{
					array_maquinas = JSON.parse(localStorage.getItem('maquinas_pre'));
					var flag = 0;
					for(var i=0;i<array_maquinas.length;i++){
						if(array_maquinas[i].tipomaquina==$('#maquina').val() && array_maquinas[i].nombre==nombre){
							flag = 1;
						}
					}
					if (flag!=1){
						$('#error-nombre').show().delay(5000).fadeOut();
						rpta = 0;
					}else{
						rpta = 1;
					}
				}
				switch(codigo){
				    case "02":
				    	VerError("kgs_hora");
				    	VerError("titulo");
				        break;
				    case "03":
				    	if (parseInt(nombre,10) > 0){
					    	VerError("titulo");
				    	}else{
					    	VerError("peso_napa");
					    }
				    	VerError("vp");
				        break;
				    case "04":			        
				    	VerError("kgs_hora");
				    	VerError("titulo");
				    	VerError("vp");
				        break;
				    case "05":
				    	VerError("titulo");
				    	VerError("vp");
				        break;
				    case "06":
					    VerError("titulo");
					    VerError("torsion");
					    VerError("rpm");
				        break;
				}
				VerError("contador");
				if($('#hora').val().length!=2 || parseInt($('#hora').val())>23){
					rpta = 0;
					$('#error-hora').show().delay(5000).fadeOut();
				}
				if($('#minutos').val().length!=2 || parseInt($('#minutos').val())>59){
					rpta = 0;
					$('#error-minutos').show().delay(5000).fadeOut();
				}
				var d = new Date();
				d.setFullYear(fec.substring(0,4),fec.substring(5,7)-1,fec.substring(8,10));
				if(d.getMonth() != fec.substring(5,7)-1 || d.getDate() != fec.substring(8,10)){
					rpta = 0;
					console.log("Fecha no válida.");
					$('#error-fecha').show().delay(5000).fadeOut();
				}else{
					a = parseInt($('#annio').val(),10)
					b = parseInt(annio_2,10)
					if($('#annio').val().length!=2 || (a!=b-1 && a!=b && a!=b+1)){
						rpta = 0;
						$('#error-annio').show().delay(5000).fadeOut();
					}
				}
				function VerError(campo){
					if($(String('#'+campo)).val()==""){
						$(String('#error-'+campo)).show().delay(5000).fadeOut();
						rpta = 0;
					}
				}
				return rpta;				
			}

			function VerVacio(campo){
				valor = $(String('#'+campo)).val();
				if($(String('#'+campo)).val()==""){
					valor = "0";
				}
				return valor;
			}

		});
	})
</script>
</body>
</html>